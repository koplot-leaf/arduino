#include <Servo.h>
#include <NewPing.h>
#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>

// === OLED 설정 ===
#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire);

// === L298N 모터 제어 핀 ===
const int enablePinA = 5;
const int LeftMotorForward = 10;
const int LeftMotorBackward = 11;
const int RightMotorForward = 9;
const int RightMotorBackward = 8;
const int enablePinB = 6;

// === 초음파 핀 ===
#define trig_pin A2
#define echo_pin A3
#define maximum_distance 200

// === 가변저항 ===
#define potPin A0

boolean goesForward = false;
int distance = 100;
int speedValue = 150;

NewPing sonar(trig_pin, echo_pin, maximum_distance);
Servo servo_motor;

void setup() {
  // OLED 초기화
  display.begin(SSD1306_SWITCHCAPVCC, 0x3C);
  display.clearDisplay();
  display.setTextSize(2);
  display.setTextColor(WHITE);
  display.setCursor(0, 0);
  display.println("RC CAR");
  display.println(" START!");
  display.display();
  delay(1500);

  // 모터 핀 설정
  pinMode(enablePinA, OUTPUT);
  pinMode(RightMotorForward, OUTPUT);
  pinMode(LeftMotorForward, OUTPUT);
  pinMode(LeftMotorBackward, OUTPUT);
  pinMode(RightMotorBackward, OUTPUT);
  pinMode(enablePinB, OUTPUT);

  pinMode(potPin, INPUT);

  servo_motor.attach(3);
  servo_motor.write(115);
  delay(2000);

  distance = readPing();
}

void loop() {
  // === 가변저항으로 속도 읽기 ===
  speedValue = analogRead(potPin);
  speedValue = map(speedValue, 0, 1023, 0, 255);
  speedValue = constrain(speedValue, 80, 255);

  // === 초음파 센서 거리 측정 ===
  distance = readPing();
  bool obstacle = (distance <= 40);

  // === OLED 업데이트 ===
  updateOLED(speedValue, distance, obstacle);

  delay(50);

  // === 장애물 회피 로직 ===
  int distanceRight = 0;
  int distanceLeft = 0;

  if (distance <= 40){
    moveStop();
    delay(100);
    moveBackward();
    delay(200);
    moveStop();
    delay(300);

    distanceRight = lookRight();
    delay(300);
    distanceLeft = lookLeft();
    delay(300);

    if (distanceRight >= distanceLeft){
      turnRight();
      moveStop();
    }
    else{
      turnLeft();
      moveStop();
    }
  }
  else{
    moveForward();
  }
}

// === OLED 업데이트 함수 ===
void updateOLED(int speedValue, int distance, bool obstacle) {
  display.clearDisplay();
  display.setTextSize(1);

  display.setCursor(0, 0);
  display.print("Speed: ");
  display.println(speedValue);

  display.setCursor(0, 15);
  display.print("Distance: ");
  display.print(distance);
  display.println(" cm");

  display.setCursor(0, 30);
  display.print("Obstacle: ");
  display.println(obstacle ? "YES" : "NO");

  display.display();
}

// === 서보로 오른쪽/왼쪽 확인 ===
int lookRight(){  
  servo_motor.write(50);
  delay(400);
  int dist = readPing();
  servo_motor.write(115);
  return dist;
}

int lookLeft(){
  servo_motor.write(170);
  delay(400);
  int dist = readPing();
  servo_motor.write(115);
  return dist;
}

// === 초음파 센서 거리 읽기 ===
int readPing(){
  delay(70);
  int cm = sonar.ping_cm();
  if (cm == 0) cm = 250;
  return cm;
}

// === 모터 제어 함수 ===
void moveStop(){
  digitalWrite(RightMotorForward, LOW);
  digitalWrite(LeftMotorForward, LOW);
  digitalWrite(RightMotorBackward, LOW);
  digitalWrite(LeftMotorBackward, LOW);
}

void moveForward(){
  if(!goesForward){
    goesForward=true;
    digitalWrite(LeftMotorForward, HIGH);
    digitalWrite(RightMotorForward, HIGH);
    digitalWrite(LeftMotorBackward, LOW);
    digitalWrite(RightMotorBackward, LOW);
  }
  analogWrite(enablePinA, speedValue);
  analogWrite(enablePinB, speedValue);
}

void moveBackward(){
  goesForward=false;
  digitalWrite(LeftMotorBackward, HIGH);
  digitalWrite(RightMotorBackward, HIGH);
  digitalWrite(LeftMotorForward, LOW);
  digitalWrite(RightMotorForward, LOW);
  analogWrite(enablePinA, speedValue);
  analogWrite(enablePinB, speedValue);
}

void turnRight(){
  digitalWrite(LeftMotorForward, HIGH);
  digitalWrite(RightMotorBackward, HIGH);
  delay(5);
  digitalWrite(LeftMotorBackward, LOW);
  digitalWrite(RightMotorForward, LOW);
  analogWrite(enablePinA, speedValue);
  analogWrite(enablePinB, speedValue);
  delay(250);
}

void turnLeft(){
  digitalWrite(LeftMotorBackward, HIGH);
  digitalWrite(RightMotorForward, HIGH);
  delay(5);
  digitalWrite(LeftMotorForward, LOW);
  digitalWrite(RightMotorBackward, LOW);
  analogWrite(enablePinA, speedValue);
  analogWrite(enablePinB, speedValue);
  delay(250);
}
